---
title: " Boye Kinzig Stream Parasites "
author: "Annemie Doliwa and Frédéric Mahé"
date: '`r format(Sys.time(), "%d %B %Y")`'

output:
  rmarkdown::html_document:
    theme: lumen
    toc: yes
    toc_float: TRUE
    keep_md: yes
    # code_folding: hide
---

```{r setup, include=FALSE}
rm(list = ls()) # remove all objects before starting
knitr::opts_chunk$set(echo = TRUE)
```


#### load required packages

```{r packages, message=FALSE}
library(here)
library(tidyverse)
library(readxl)
library(vegan)
```

# preliminary steps

### variables and functions

```{r}
input <- "full_table_Boye21_AD_OpenRefine05.10..xlsx"
output <- str_replace(input, "..xlsx", "_reduced_taxonomy.tsv")
annotated_table <- str_replace(output, ".tsv", ".xlsx")
eukaryotic_rarefied_file <- str_replace(input, "..xlsx", "_eukaryotic_rarefied.tsv")
seed <- 123
n_subsamplings <- 100
cbPalette <- c("#000000", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
load_raw_occurrence_data <- function(filename){
    here::here("data", filename) %>%
        readxl::read_xlsx(na = c("", "NA")) %>%
            select(-sequences) %>%
            mutate(across(.cols = -c(seqid, starts_with("taxonomy")),
                          .fns = as.numeric))
}
```


## extract a list of unique taxa

That shorter list will then be annotated to identify parasitic taxa.

```{r}
load_raw_occurrence_data(input) %>%
        select(starts_with("taxonomy")) %>%
        mutate(across(everything(), ~ str_remove(., " *\\([0-9]+\\)"))) %>%
        arrange(across(everything())) %>%
        distinct() %>%
        write_tsv(here::here("data", output))
```


## extract a list of parasitic taxa

Annemie and Micah have annotate the table.

```{r}
here::here("data", annotated_table) %>%
    readxl::read_xlsx(skip = 1) %>%
        select(ParasiticTax) %>%
        filter(! is.na(ParasiticTax)) %>%
        distinct() %>%
        pull() -> known_parasites

known_parasites
```

There are `r length(known_parasites)` taxa marked at parasites, at
different taxonomic levels.


## checks and filtering

here we go!

```{r}
load_raw_occurrence_data(input) -> raw_table
```

how many reads per sample?

```{r}
raw_table %>%
    select(-starts_with("taxonomy")) %>%
    pivot_longer(cols = -seqid,
                 names_to = "samples",
                 values_to = "reads") %>%
    count(samples, wt = reads, name = "reads") %>%
    pull(reads) -> sample_sizes

sample_sizes %>%
    summary()

sample_sizes %>%
    min() -> smallest_sample

rm(sample_sizes)
```

how many reads per domain?

```{r}
taxonomy_columns_to_discard <- paste(c("taxonomy"), 2:8, sep = " ")

raw_table %>%
    select(-taxonomy_columns_to_discard) %>%
    rename(domain = `taxonomy 1`) %>%
    mutate(domain = str_remove(domain, " *\\([0-9]+\\)")) %>%
    pivot_longer(cols = -c(seqid, domain),
                 names_to = "samples",
                 values_to = "reads") %>%
    count(domain, wt = reads, name = "reads") %>%
    mutate(percentage = 100 * reads / sum(reads))

rm(taxonomy_columns_to_discard)
```

Note that there are no unassigned reads, which is a bit surprising,
even for 18S V9 reads. It is safe to exclude all reads assigned to
Bacteria.


# Eukaryots

Exclude bacteria:


```{r}
raw_table %>%
    filter(str_detect(`taxonomy 1`, "Bacteria", negate = TRUE)) -> eukaryotic_table

rm(raw_table)
```


## list supergroups

```{r}
eukaryotic_table %>%
    rename(supergroup = `taxonomy 2`) %>%
    mutate(supergroup = str_remove(supergroup, " *\\([0-9]+\\)")) %>%
    select(-seqid, -starts_with("taxonomy")) %>%
    rowwise() %>%
    mutate(reads = sum(c_across(-supergroup)), .keep = "unused") %>%
    ungroup() %>%
    count(supergroup, wt = reads, name = "reads", sort = TRUE) %>%
    mutate(percentage = 100 * reads / sum(reads),
           cumulative_perc = cumsum(percentage))
```

The dataset is dominated by Opisthokonta, Stramenopiles and
Archaeplastida.


## rarefaction (random subsampling)

### local functions

Prepare to remove empty OTUs from the final rarefied table:

```{r}
. %>%
    t() %>%
    as.data.frame() %>%
    as_tibble() -> transpose_back_to_tibble

. %>%
    rowwise() %>%
    mutate(reads = sum(c_across(-seqid)), .keep = "all") %>%
    ungroup() %>%
    filter(reads > 0) %>%
    select(-reads) -> remove_empty_OTUs
```


### make a transposed table

Remove columns that are not samples:

```{r}
eukaryotic_table %>%
    select(-seqid, -starts_with("taxonomy")) %>%
    t() -> eukaryotic_table_transposed

eukaryotic_table %>%
    select(seqid) -> OTU_ids
```

Clean up:

```{r}
rm(eukaryotic_table)
```


### randomly subsample the table

Randomly subsample the table, so all samples have the same number of
reads. Repeat the process `r n_subsamplings` times to make sure that
the final profile is as close as possible to the initial
distribution. Use a fix seed to make the process 100% repeatable. That
step can take several minutes to run.

```{r}
set.seed(seed)
matrix1 <- vegan::rrarefy(eukaryotic_table_transposed, smallest_sample)
for (i in 2:n_subsamplings) {
    matrix1 <- matrix1 + vegan::rrarefy(eukaryotic_table_transposed, smallest_sample)
}

matrix1 / n_subsamplings -> eukaryotic_table_transposed_rarefied

rm(i, n_subsamplings, matrix1, eukaryotic_table_transposed)
```


### rebuild and save the rarefied table

Rarefaction is computationally expensive, so the rarefied table should
be saved:

```{r}
OTU_ids %>%
    bind_cols(eukaryotic_table_transposed_rarefied %>%
              transpose_back_to_tibble) %>%
    remove_empty_OTUs -> eukaryotic_table_rarefied

eukaryotic_table_rarefied %>%
    write_tsv(file = here::here("data", eukaryotic_rarefied_file))
```

Note that there are no empty OTUs after rarefaction.


### sanity check

How many reads per sample in the final table?

```{r}
eukaryotic_table_rarefied %>%
    pivot_longer(cols = -seqid,
                 names_to = "samples",
                 values_to = "reads") %>%
    count(samples, wt = reads, name = "reads") %>%
    select(reads) %>%
    summary()
```

As expected, there are now
`r prettyNum(smallest_sample, scientific=FALSE, big.mark=",")`
 reads in all samples.


Clean up:

```{r}
rm(eukaryotic_rarefied_file, OTU_ids)
```


## NMDS (locality)

### computation

Dissimilarity (Bray-Curtis) and ordination (NMDS):

```{r}
set.seed(seed)

eukaryotic_table_transposed_rarefied %>%
    vegan::vegdist(., method = "bray") %>%
    vegan::metaMDS(.) -> occurrences_t.bray.nmds
```


### prepare results

extract data scores and add stress value:

```{r}
stress <- occurrences_t.bray.nmds$stress
samples <- rownames(eukaryotic_table_transposed_rarefied)
data.scores <- as.data.frame(vegan::scores(occurrences_t.bray.nmds,
                                           display = "sites"))
data.scores$samples <- rownames(data.scores)

x_min <- min(data.scores$NMDS1)
x_max <- max(data.scores$NMDS1)
y_max <- max(data.scores$NMDS2)
stress_annotation <- paste("stress: ", round(stress, digits = 4), sep = "")
```

parse sample names:

```{r}
data.scores %>%
    separate(col = samples,
             into = c("locality", NA),
             sep = 3) -> ordination_coordinates
```

Clean up:

```{r}
rm(data.scores, eukaryotic_table_transposed_rarefied)
```


### plot

```{r}
title <- "Boye Kinzig rivers 18S V9 all eukaryots NMDS"

ggplot(data = ordination_coordinates,
       aes(x = NMDS1, y = NMDS2, fill = locality)) +
    scale_fill_manual(values = cbPalette) +
    scale_colour_manual(values = cbPalette) +
    geom_point(size = 6, shape = 21, colour = "black", stroke = 0.5) +
    theme_bw(base_size = 16) +
    ggtitle(title) +
    annotate("text", x = x_max - abs(x_max / 4),
             y = y_max, label = stress_annotation) -> nmds_plot

nmds_plot
```

No obvious structuration.

Add ellipses representing t-distributions (solid lines) and normal
distributions (dashed lines):

```{r}
nmds_plot +
    stat_ellipse(aes(colour = locality), type = "norm", linetype = 2) +
    stat_ellipse(aes(colour = locality), type = "t", linetype = 1)
```

The t-distribution, also known as Student's t-distribution, is a type
of normal distribution used for smaller sample sizes, where the
variance in the data is unknown.


Clean up:

```{r}
rm(nmds_plot, occurrences_t.bray.nmds, samples, stress,
   stress_annotation, title, x_min, x_max, y_max)
```


***

```{r}
sessionInfo()
rm(list = ls())
```
